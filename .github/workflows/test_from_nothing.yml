name: Test setup Nim from nothing.
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-22.04-arm, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    env:
      NIM_VERSION: '2.2.6'
      NIMBY_VERSION: '0.1.18'
    steps:
      - name: Setup Nim via Nimby (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          set -e
          echo "Downloading Nimby for Windows..."
          curl -sSL -o nimby.exe "https://github.com/treeform/nimby/releases/download/$NIMBY_VERSION/nimby-Windows-X64.exe"
          chmod +x nimby.exe
          echo "Using Nimby to install Nim $NIM_VERSION..."
          ./nimby.exe use "$NIM_VERSION"
          cp nimby.exe $HOME/.nimby/nim/bin/nimby.exe
          echo "Adding Nim bin to PATH..."
          echo "$(cygpath -w "$HOME")\.nimby\nim\bin" >> "$GITHUB_PATH"

      - name: Setup Nim via Nimby (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -e
          arch="$(uname -m)"
          NIMBY_URL="https://github.com/treeform/nimby/releases/download/$NIMBY_VERSION/nimby-macOS-ARM64"
          echo "Downloading Nimby for macOS ($arch)..."
          curl -sSL -o nimby "$NIMBY_URL"
          chmod +x nimby
          echo "Using Nimby to install Nim $NIM_VERSION..."
          ./nimby use "$NIM_VERSION"
          cp nimby $HOME/.nimby/nim/bin/nimby
          chmod +x $HOME/.nimby/nim/bin/nimby
          echo "Adding Nim bin to PATH..."
          echo "$HOME/.nimby/nim/bin" >> "$GITHUB_PATH"

      - name: Setup Nim via Nimby (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -e
          arch="$(uname -m)"
          if [ "$arch" = "aarch64" ] || [ "$arch" = "arm64" ]; then
            NIMBY_URL="https://github.com/treeform/nimby/releases/download/$NIMBY_VERSION/nimby-Linux-ARM64"
          else
            NIMBY_URL="https://github.com/treeform/nimby/releases/download/$NIMBY_VERSION/nimby-Linux-X64"
          fi
          echo "Downloading Nimby for Linux ($arch)..."
          curl -sSL -o nimby "$NIMBY_URL"
          chmod +x nimby
          echo "Using Nimby to install Nim $NIM_VERSION..."
          ./nimby use "$NIM_VERSION"
          cp nimby $HOME/.nimby/nim/bin/nimby
          chmod +x $HOME/.nimby/nim/bin/nimby
          echo "Adding Nim bin to PATH..."
          echo "$HOME/.nimby/nim/bin" >> "$GITHUB_PATH"

      - name: Install Fidget2
        run: nimby install fidget2

      - name: List Installed Nim packages
        run: nimby list

      - name: List Dependencies in Tree View
        run: nimby tree fidget2

      - name: Test Fidget2 Compilation
        run: nim c -r fidget2/src/fidget2.nim
