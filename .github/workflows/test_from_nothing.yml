name: Test setup Nim from nothing.
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
inputs:
  nim-version:
    description: >-
      The Nim version to download and use. Example: 2.2.6
    default: '2.2.6'
  nimby-version:
    description: >-
      The Nimby version to download and use. Example: 0.1.7
    default: '0.1.7'
jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:

      - name: Setup Nim via Nimby (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          set -e
          echo "Downloading Nimby for Windows..."
          curl -sSL -o nimby.exe "https://github.com/treeform/nimby/releases/download/${{ inputs.nimby-version }}/nimby-Windows-X64.exe"
          chmod +x nimby.exe
          echo "Using Nimby to install Nim ${{ inputs.nim-version }}..."
          ./nimby.exe use "${{ inputs.nim-version }}"
          cp nimby.exe $HOME/.nimby/nim/bin/nimby.exe
          echo "Adding Nim bin to PATH..."
          echo "$(cygpath -w "$HOME")\.nimby\nim\bin" >> "$GITHUB_PATH"

      - name: Setup Nim via Nimby (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -e
          arch="$(uname -m)"
          if [ "$arch" = "arm64" ]; then
            NIMBY_URL="https://github.com/treeform/nimby/releases/download/${{ inputs.nimby-version }}/nimby-macOS-ARM64"
          else
            NIMBY_URL="https://github.com/treeform/nimby/releases/download/${{ inputs.nimby-version }}/nimby-macOS-X64"
          fi
          echo "Downloading Nimby for macOS ($arch)..."
          curl -sSL -o nimby "$NIMBY_URL"
          chmod +x nimby
          echo "Using Nimby to install Nim ${{ inputs.nim-version }}..."
          ./nimby use "${{ inputs.nim-version }}"
          cp nimby $HOME/.nimby/nim/bin/nimby
          chmod +x $HOME/.nimby/nim/bin/nimby
          echo "Adding Nim bin to PATH..."
          echo "$HOME/.nimby/nim/bin" >> "$GITHUB_PATH"

      - name: Setup Nim via Nimby (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -e
          echo "Downloading Nimby for Linux..."
          curl -sSL -o nimby "https://github.com/treeform/nimby/releases/download/${{ inputs.nimby-version }}/nimby-Linux-X64"
          chmod +x nimby
          echo "Using Nimby to install Nim ${{ inputs.nim-version }}..."
          ./nimby use "${{ inputs.nim-version }}"
          cp nimby $HOME/.nimby/nim/bin/nimby
          chmod +x $HOME/.nimby/nim/bin/nimby
          echo "Adding Nim bin to PATH..."
          echo "$HOME/.nimby/nim/bin" >> "$GITHUB_PATH"

      - name: Install Fidget2
        run: nimby install fidget2

      - name: List Installed Nim packages
        run: nimby list

      - name: List Dependencies in Tree View
        run: nimby tree fidget2

      - name: Test Fidget2 Compilation
        run: nim c -r fidget2/src/fidget2.nim
